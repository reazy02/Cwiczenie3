#!/bin/bash

CONFIG="/etc/mybackup.conf"
source "$CONFIG"

CURRENT_DIR="$BACKUP_DIR/current"
ARCHIVE_DIR="$BACKUP_DIR/archive"

mkdir -p "$CURRENT_DIR"
mkdir -p "$ARCHIVE_DIR"

DAY_FILE="$CURRENT_DIR/day_number"

# Jeżeli nie ma pliku DAY_NUMBER, zaczynamy od 1
if [ ! -f "$DAY_FILE" ]; then
    DAY=1
else
    DAY=$(cat "$DAY_FILE")
fi

TARGET="$CURRENT_DIR/day$DAY"

echo "=== Backup – dzień $DAY ==="

# DAY 1 – FULL BACKUP
if [ "$DAY" -eq 1 ]; then
    echo "Tworzenie pełnej kopii..."
    rsync -a --delete "$SOURCE/" "$TARGET/"
else
    # DAY 2..N – INCREMENTAL (hardlinks)
    PREV_DAY=$((DAY - 1))
    PREV="$CURRENT_DIR/day$PREV_DAY"
    
    echo "Tworzenie przyrostowej kopii..."
    rsync -a --delete \
        --link-dest="$PREV" \
        "$SOURCE/" "$TARGET/"
fi

#################################################################
# Zakończenie okresu
#################################################################

if [ "$DAY" -ge "$PERIOD_DAYS" ]; then
    echo "=== Koniec okresu – archiwizacja ==="

    TIMESTAMP=$(date +%Y-%m-%d_%H-%M)
    ARCHIVE_NAME="${PERIOD_NAME}_${TIMESTAMP}.tar.gz"

    tar -czf "$ARCHIVE_DIR/$ARCHIVE_NAME" -C "$CURRENT_DIR" .

    echo "--- Wysyłanie na zdalny host ---"
    rsync -av "$ARCHIVE_DIR/$ARCHIVE_NAME" "$REMOTE_HOST:$REMOTE_PATH"

    echo "--- Czyszczenie bieżącego okresu ---"
    rm -rf "$CURRENT_DIR"/*
    DAY=0
fi

#################################################################
# Aktualizacja licznika
#################################################################

DAY=$((DAY + 1))
echo "$DAY" > "$DAY_FILE"

echo "Backup zakończony."
exit 0
